# Koubot 使用文档

[TOC]



## 命令机制详解

可能会看起来比较复杂，但其实是一种函数思想、计算机命令思想，学会后也有益无害，受益终生（bushi

看不懂也没关系，摸索摸索就会用了（？

**一些符号的科普（会在内置插件帮助手册中出现）**

方括号`“[]”`是表示**可选**内容，即可省略的。

尖括号`“<>”`是表示**必填**内容，不可省略的。

分隔符`“|”`是表示分隔，在Koubot中的意思是**或**，就是被分隔的东西都是等效的，用哪个都可以

**参数**

参数的意思是一种变量，它可以被赋值。比如数学中有叫未知数x、y之类的东西，它可以赋予各种数字。但参数/变量赋予的东西与它本身的属性有关系，比如某个参数`text`是接受字符串类型也就是一段文字类型的值，那么需要给它一段文字。比如**参数**`text = "文字"` ，意思是去访问参数text，那么会得到"文字"，即text这个**参数的内容**是“文字”。在Koubot命令机制中这种赋值方式是`-text 文字` ，两者是等效的。

### 命令机制

> 注：如果理解面向对象，那么就更容易理解kou的命令机制原理了：**命令调用的一个插件就是一个类，插件中的功能即是类的一个方法，插件中的参数即是类中的属性**，实际上就是将类和方法和属性映射到了一条命令

一句话概括就是

`<激活关键字><插件激活名>[.模块名等拓展]  [功能激活名]  [隐式参数内容1]  [隐式参数内容2] [隐式参数内容3...]     [-显式参数激活名1 [内容]]   [-显式参数激活名2 [内容]]  [--内置参数名1 [内容]] [--内置参数名2 [内容]]`

#### 举例

用一个功能使用做例子。目前机器人设定的激活名是"/"，有一个自定义回复的系统插件，插件激活名是reply（使用/help获取当前安装插件与对应激活名），那么可以使用`/reply --h`获取插件详细帮助。

```
ID16.自定义关键词回复[reply]v1.0.7745.1991 by 7zou
帮助：（系统插件）自定义关键词回复
-----
所有支持的功能：
FID176.增加自定义回复[增加|add]
FID177.删除自定义回复[删除|delete]
FID178.自定义回复默认功能[default]
-----
-----第1/2页-----
```

然后输入`fid176`

```
FID176.增加自定义回复[增加|add]
帮助：成功返回增加的自定义回复信息
用法：<关键字> <回复语> [-global 设置为全局] [-group 设置为群组] [-advanced 使用正则语法] [-at 需要艾特Kou才获取自动回复] [-p 回复可能性%]
权限：所有成员
----功能参数(类型 - 参数名)----
String - 关键字
String - 回复语
----支持的插件属性参数----
PID75.设置为全局[global]
PID76.设置为群组[group]
PID77.使用正则语法[advanced]
PID78.需要艾特Kou才获取自动回复[at]
PID79.回复可能性%[p]
```

根据用法与前面得到的功能激活名，我们可以使用命令调用增加自定义回复的功能了，比如输入命令

`/reply add *抽签* 恭喜 -group -p 20 -advanced --sleep 10min` 

那么十分钟后（为了演示内置参数而使用命令延时），就会收到增加一个自定义回复的提示，是：在当前群内回复包含“抽签”的一句话，有20%的几率会回复“恭喜”。

```
将在2021/3/13 13:26:24(10分钟后)执行指令
//10min钟后
增加自定义回复成功
增加了ID[20.00%][正则][群]41."^(.*)抽签(.*)" = "恭喜"
```

#### 解释

**激活关键字**激活机器人->**插件激活名**激活插件->**功能激活名**激活功能->传递功能所需要的参数或内置参数等 然后Kou就会帮你调用所激活的插件给你结果。

##### 激活关键字"/" （目前设定为/）

告诉Kou你在使用Kou的功能

##### 插件激活名"reply"

告诉Kou我会使用`reply`这个插件

##### 功能激活名"add"

告诉Kou我会使用`reply`插件的`add`功能，传入功能的是隐式参数，与功能函数所需要传入的参数一一对应，顺序不可改变。比如假设该功能函数对应的就是add(string, string)，我们输入的`add *抽签* 恭喜`，实际上调用的就是`add("*抽签*", "恭喜")`这个函数。

> PS：如果是默认功能就不需要写功能激活名

##### 隐式参数内容"\*抽签\*" "恭喜"

告诉Kou我会将"\*抽签\*" "恭喜"两个内容传递给功能add。

##### 显式参数赋值"-p 50"、"-advanced"、"-group"

告诉Kou我会赋值哪些插件参数：参数p = 50，参数advanced = true、参数group = true（advanced和group是布尔类型参数，只有true和false两种情况，这里设定为只要使用该参数，不必赋值，则自动认为是true）

意思是调用插件reply时，add功能的概率设置为50%，advanced模式开启（`*抽签*`意思是抽签前面或后面任意字符都可，这是我为kou系统设计的简便正则写法，最终会转换为真正的正则表达式`^(.*)抽签(.*)`），且设定为当前群组模式。

##### 内置参数赋值"--sleep 10min"

告诉Kou我会使用并赋值哪些内置参数（类似于显式参数，不同的是内置参数是Kou系统范畴的，需要两个"-"，而显式参数则是插件范畴的，需要一个"-"）

这里使用了sleep这个内置参数，即告诉系统将内置参数sleep赋值 = 10min



### 深入说明

> 注：Kou的命令机制都是按照空格来区分赋值的内容的

#### 显式参数

就是写明了的参数赋值，比如上面那个例子调用

`-p 50 -advanced -group`这三个参数都是显式参数，需要写参数的激活名。然后**顺序可以随意调换**，而且实际上甚至可以放在隐式参数之中，顺序非常灵活。比如

`/reply add *抽签* 恭喜 -group -p 20 -advanced --sleep 10min` 

与

`/reply add -group -p 20 *抽签* --sleep 10min 恭喜 -advanced ` 

是等效的

#### 隐式参数

就是不需要写参数名，只需要写参数内容，自动按**空格**区分，**顺序不能改变**。

原因的话这里普及一下**函数**



#### 函数/方法

是编程中的术语，方法是针对对象的函数的说法。对象这个术语不详细解释了，简单比方说一个人就是一个对象。这里bot的插件也是一个对象。

函数在一般编程语言中的简单定义是

函数名（参数类型 参数名1，参数类型 参数名2 ...）

再简化

函数（参数1，参数2）

这里参数1、参数2的顺序不能改变，类比到Koubot中的隐式参数，比如前面例子中这样使用`add *抽签* 恭喜`，在前面例子中就提到假设其函数是这样的`add(string, string)`，对应调用的就是`add("*抽签*", "恭喜")`



#### 区分关键字

Koubot中还有一种叫区分关键字的东西，就是在参数赋值的时候为了让bot更好区分哪个是哪个，因为默认是按**空格**来区分的，若是传递的内容之间还有空格的话会造成**歧义** （其实就参数赋值的时候最好不用空格，隐式参数调用一般不会歧义）

分为简单区分关键字、加强区分关键字。

目前来说两者作用一样，都可用于区分，字面意思就是简单区分输入的方式简单，加强区分输入方式比较麻烦但是效果好。

假设现在设定的简单区分关键字是`#`，加强区分关键字是`<#  #>`那么如果有一个翻译插件trans，默认功能是翻译成中文，接收一个参数翻译内容。

帮助上会直接这样写：<翻译内容>，意思是接收一个必填参数，翻译内容

如果其中有空格调用方法就是

`/trans #Kou 最高です#`，这样实际翻译的内容是`Kou 最高です`

如果翻译内容中含有#，与区分关键字冲突的话就得改用加强型`/trans <#Kou #最高です##>`  然后Kou实际接收到的内容是` Kou #最高です#`

但实际上，我还实现了一个隐藏功能叫**隐式参数合并**。就算不输入区分关键字，因为只接收一个参数，不管多少空格都会被看作是一个参数（多个参数也有效，多余的会合并到最后一个参数上去），所以可以直接这样调用`/trans Kou 最高です`

#### 内置参数

每个命令里面默认都也许大概可能支持的参数（部分内置参数需要权限或插件设置支持）（一般也可以叠buff）（需要两个-）

| 内置参数                | 说明                                                         |
| ----------------------- | ------------------------------------------------------------ |
| --help/h                | 查找当前使用的插件、使用的功能、使用的参数的帮助             |
| --sleep <时间长度>      | 当前命令延迟指定时间，目前限制最长2天，注意每次kou更新会导致失效 |
| --t <时间长度>          | 设定某些特性支持的时间长度，如命令管道                       |
| --sudo <用户>/--@<用户> | switch user do 以其他用户身份来执行插件功能（仅对调用插件有效，不是针对整个指令） |
| --public/private        | 必定公开/私聊发送结果                                        |
| --sgdo <群组>           | switch group do 切换到其他群组执行插件功能                   |
| --g <群组>              | 指定插件功能目标群组，比如用于禁言等需要在群组中使用的功能   |
| --pipe [临时关键字]     | 以当前命令快速建立前缀管道                                   |
| --n                     | next，将接收用户下一次输入的内容作为隐式参数，可以用于发图等 |
| --at                    | 回复时艾特指定用户，支持同时艾特多个人                       |



#### 使用别名插件（alias）

调用命令实际上总是很繁琐的事情，人们更倾向于自然语言式的调用，因此我开发了一个系统内置插件叫做命令别名，激活名为alias。

如果将一段话翻译成中文的功能的命令是`/trans -to 中文 XXX XXX XXX `，我们其实可以做到直接`翻译XXX XXX XXX`，即是调用的那个命令。

具体方式是`/alias add 翻译 （/trans -to 中文 ） -group`，（`（）`是目前设定的区分关键字，因为现在输入有空格）那么就给群组增加了这样一个alias：每当遇到输入以翻译开头，那么自动的将翻译替换为`/trans -to 中文 `，然后接收后面的输入。 

该功能还支持正则等高级用法，具体使用`/trans add --h`查看帮助手册。



### Kou型类型（KouType） 

在插件的调用中，所有int、string、double等类型都是kou型类型，并非常规的类型，拓展了很多种输入。

- 【bool】 Kou型布尔类型（可以不用赋值） 比如-group 参数，只要用上，默认是将参数group赋值为true。

- 【string】Kou型字符串，实际上就是文字，注意某些地方可以支持正则输入（比如数据库自动模型搜索功能、alias插件、自定义回复插件），输入原始正则可以使用`r(xxxx)`，其中xxx为正则表达式

  另外自行拓展的简易正则可以用`a*`代表以a开头，`*b`代表以b结尾，`*c*`代表包含c

  > 扩展：`a*?b*`代表以a开头后中间有任意字符（?是非贪婪）然后接一个b，再接任意字符，非贪婪与贪婪的不一样之处在于，如果是`a*b*`，对于a嗨b呀b，第一个*将会收集到`嗨b呀`，第二个\*收集到空，而`a*?b*`，第一个\*收集到的是`嗨`，第二个\*收集到的是`呀b`。
  >
  > 其中另外alias插件中还可使用正则替换，详见alias插件帮助。 

- 【int】Kou型整数（即支持中文以及单位甚至表达式），比如：壹佰；500；1k、1w；一万；(sin(pi/2)^e\*100+14)*1000+五百一十肆 等等。

- 【double】 Kou型浮点数，与Kou型整数一样，只是不会截断小数部分结果了。

- 【Inteval】Kou型数字区间，支持10-100，(10,100]等区间写法。

- 【TimeSpan】Kou型时间间隔，比如：一炷香（30分钟），一小时，1h5m（一小时五分钟），1:00（1分钟）,50（50秒），后天早上八点（自动计算当前到后天早上八点距离）等等。

- 【Enum】Kou型枚举，这个每个设定不一样，比如Arcaea游戏中的难度，future难度可以使用ftr、future等输入。

- 【平台用户】支持使用聊天平台中的@功能@他人作为输入，也可以输入目标用户的设定的昵称（是kou的平台用户昵称设置）、也可以输入目标用户的平台账号id（如QQ号）

- 【平台群组】可以使用kou中群组设定的群组昵称，也可以使用平台群组id号（如QQ群组号）

- 【M】以上所有支持的类型，可以使用分割符进行多个输入，例如支持类型为【M|int】，那么可以这样输入：1、5千，2+3，这样插件可以接收到一个列表{1,5000,5}，包含输入的三个数据。





### 数据库自动模型

直接拿例子举例，如果名为arc的插件下绑定了一个歌曲信息的model类，且其表激活名为song，则我们使用数据库自动模型的内置帮助功能查看使用方式（当没有指明是增删改查时，默认是查询功能）：

`/arc.song help`

```
ID1.Arcaea歌曲[arc.song]
搜索权：所有成员
备注：(M)代表Multi可赋值多个，用"，"等分割符隔开，之间是或关系。(S)代表Sort，可使用desc、asc等关键字进行特定字段排序
支持操作：增加、删除、修改、查询
---字段---
13.String (SM)SongTitle[曲名]
14.String (SM)SongArtist[曲师]
15.String (SM)ChartDesigner[谱师]
-----第1/2页-----
//输入n翻到下一页
16.String (SM)JacketDesigner[画师]
19.String (SM)ChartRating[难度]
20.数字区间 (SM)ChartConstant[定数]
21.数字区间 (SM)SongBpm[bpm]
22.TimeSpan (SM)SongLength[长度]
23.Enum (SM)ChartRatingClass[难度类别]
30.String (M)曲名俗称[别名]
-----第2/2页-----
```

支持的字段，其激活名与其支持的搜索功能需要从以上帮助中得知。

也可以显式指明增删改查，也有对应的帮助，增删改帮助会提供一些候选键、必填、以及权限是否足够等帮助。

`/arc.song.add help` 、`/arc.song.delete help`、`/arc.song.modify help`、`/arc.song.search help //默认是搜索功能不需要指明`

由于arc.song设定不支持增删改，我们可以看一个能够进行增删改的帮助：

```
ID6.罗马音-中文谐音表[romaji.list]
当前动作：删除
变动权：Bot管理
备注：(*)代表必填字段；(x)代表当前动作不支持字段；(1)代表一号候选键，(K)为主键（也是候选键），变动需要填写任意一组候选键组合来唯一确定变动的数据。
支持操作：增加、删除、修改、查询
---字段---
1.Int (K)Id[id]
2.String (1)罗马音名[romaji|罗马音]
3.String 中文谐音[zh|中文]
```

我们直接以复杂的条件查询举例，使用字段激活名曲名、曲师、定数来组成一个过滤条件

`/arc.song -曲名 *a*，asc -曲师 ak*，b* -定数 dsc3`

意思是曲名符合包含a的，结果按照曲名升序（asc意思是ascending，升序），曲师是以ak开头的，或者是以b开头的，然后结果按照定数以三倍权重排序。

实际上也可以不需要使用显式参数形式去调用，以下命令在大多数情况下与上面命令等效

`/arc.song 曲名*a*，asc 曲师ak*，b* 定数dsc3`

结果如下：

```
172.Axium Crisis [Future 10+(10.9)]
   曲师：ak+q
370.SUPERNOVA [Future 9+(9.8)]
   曲师：BACO
346.Antithese [Future 8(8.8)]
   曲师：Blacklolita
343.Solitary Dream|虚空の夢 [Future 8(8.8)]
   曲师：ak+q feat. Sennzai
45.Vexaria [Beyond 8(8.8)]
   曲师：ak+q
还有14个记录...
-----第1/4页-----
//输入172
//歌曲图片这里不显示
172.Axium Crisis [Future 10.9]
曲师：ak+q
画师：シエラ
BPM：170
歌曲长度：00:02:31
曲包：yugamu
谱师：The Monolith
note总数：1094
地键：474
天键：207
蛇：377
长条：36
```

> PS：翻页与输入id即可获取信息的功能依赖于会话机制，详见**会话机制**的帮助
>

#### 自带功能

上面有用到了help功能，显示增删改查的帮助信息。

另外还有随机功能，可以在结果中随机，（使用自动模型内置参数 -random count可以随机多个）

`/arc.song 随机 曲名*a*，asc 曲师ak*，b* 定数dsc3`

还可以查看所有表内的数据

`/arc.song all`